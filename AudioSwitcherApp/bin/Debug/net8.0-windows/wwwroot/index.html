<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Switcher Generator</title>
    <style>
        /* 暗色主题和 macOS/Apple 风格 */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; 
            padding: 25px; 
            background: #1c1c1e; /* 深色背景 */
            color: #e5e5e5; /* 浅色文字 */
            user-select: none; 
            margin: 0;
            overflow: hidden; /* 防止滚动条 */
        }
        .container {
            background: #2c2c2e; /* 容器背景，比 body 亮一点 */
            border-radius: 12px; /* 圆角设计 */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            padding: 20px;
        }
        h2 { 
            color: #ffffff; 
            font-weight: 600; 
            margin-top: 0;
            display: flex;
            align-items: center;
        }
        h2 svg {
            margin-right: 10px;
            fill: #0a84ff; /* Apple 蓝 */
        }
        
        /* 设备列表样式 */
        #list-container { 
            background: #3a3a3c; /* 列表区域背景 */
            padding: 10px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #48484a;
        }
        .device-item { 
            display: flex; 
            align-items: center; 
            padding: 12px 10px; 
            border-bottom: 1px solid #48484a; 
            transition: background-color 0.1s;
        }
        .device-item:hover {
            background-color: #48484a; /* 悬停效果 */
        }
        .device-item:last-child { border-bottom: none; }
        
        /* 复选框样式 (定制化) */
        input[type="checkbox"] { 
            /* 隐藏默认复选框 */
            appearance: none; 
            -webkit-appearance: none;
            width: 18px; height: 18px; 
            border: 2px solid #58585a; 
            border-radius: 4px; 
            margin-right: 15px; 
            cursor: pointer; 
            position: relative;
            background-color: #2c2c2e;
        }
        input[type="checkbox"]:checked { 
            background-color: #0a84ff; /* 选中时的 Apple 蓝 */
            border-color: #0a84ff;
        }
        /* 模拟 macOS 风格的勾选符号 */
        input[type="checkbox"]:checked::before {
            content: '✓';
            color: white;
            font-size: 14px;
            position: absolute;
            top: -2px;
            left: 2px;
        }
        label { 
            cursor: pointer; 
            flex-grow: 1; 
            font-size: 14px;
            color: #ffffff;
        }
        
        /* 按钮样式 */
        button#btn-gen {
            background-color: #0a84ff; /* Apple 蓝 */
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 15px; 
            width: 100%;
            transition: background-color 0.2s, opacity 0.2s;
            opacity: 0.5; /* 默认禁用状态 */
            pointer-events: none;
        }
        button#btn-gen.active { 
            opacity: 1; 
            pointer-events: auto; 
        }
        button#btn-gen:hover.active { 
            background-color: #3893ff; 
        }

        .status-msg {
            color: #8e8e93;
            font-size: 12px;
            margin-top: 10px;
            text-align: right;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-9h4c.55 0 1 .45 1 1v2c0 .55-.45 1-1 1h-4c-.55 0-1-.45-1-1v-2c0-.55.45-1 1-1zm0-3h4c.55 0 1 .45 1 1v1c0 .55-.45 1-1 1h-4c-.55 0-1-.45-1-1v-1c0-.55.45-1 1-1z"/></svg>
            音频切换生成器
        </h2>

        <p style="color: #a8a8aa; font-size: 14px;">请选择需要循环切换的音频输出设备 (至少2个):</p>
        
        <div id="list-container">
            <div style="text-align: center; padding: 10px; color: #8e8e93;">正在扫描设备...</div>
        </div>

        <button id="btn-gen" disabled>生成切换脚本 (请至少选2个)</button>
        <div id="status-msg" class="status-msg"></div>
    </div>

    <script>
        let selectedIds = [];

        // ** 1. 接收 C# 后端消息 **
        window.external.receiveMessage(json => {
            console.log("JS LOG: 1. Received raw JSON from backend."); // 日志跟踪点
            
            try {
                const data = JSON.parse(json);
                
                if (data.type === 'list') {
                    console.log("JS LOG: 2. Parsed LIST data. Devices found:", data.payload ? data.payload.length : 0); // 日志跟踪点
                    renderList(data.payload);
                } else if (data.type === 'done') {
                    document.getElementById('status-msg').innerText = "✅ 脚本生成成功！";
                    alert(`成功生成脚本于: ${data.payload}\n\n现在你可以把生成的exe文件固定到任务栏或设为快捷键。`);
                } else if (data.type === 'err') {
                    document.getElementById('status-msg').innerText = `❌ 错误: ${data.payload}`;
                    console.error("JS ERROR:", data.payload);
                    alert("发生错误: " + data.payload);
                }
            } catch (e) {
                // *** 关键修改：将 JS 错误回传给 C# 终端 ***
                window.external.sendMessage(JSON.stringify({
                    action: 'debug_log',
                    message: 'JS_FATAL_ERROR: ' + e.message + '. Raw Data: ' + json.substring(0, 50) + '...'
                }));
                // ***************************************
                
                console.error("JS LOG: JSON Parsing Error:", e, "Raw Data:", json); 
                document.getElementById('status-msg').innerText = '❌ 数据解析失败。';
            }
        });
        // ** 2. 启动时发送请求 **
        window.external.sendMessage(JSON.stringify({ action: 'get_list' }));

        function renderList(devices) {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            
            if (!devices || devices.length === 0) {
                 container.innerHTML = '<div style="text-align: center; padding: 10px; color: #8e8e93;">未找到任何活跃的音频输出设备。</div>';
                 return;
            }

            devices.forEach(d => {
                const div = document.createElement('div');
                div.className = 'device-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = d.id;
                checkbox.onchange = () => toggle(d.id, checkbox.checked);

                const label = document.createElement('label');
                label.htmlFor = d.id;
                label.innerText = d.name;

                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        // ** 3. 勾选逻辑 **
        function toggle(id, isChecked) {
            if (isChecked) {
                selectedIds.push(id);
            } else {
                selectedIds = selectedIds.filter(item => item !== id);
            }
            updateButtonState();
        }

        // ** 4. 更新按钮状态 **
        function updateButtonState() {
            const btn = document.getElementById('btn-gen');
            if (selectedIds.length >= 2) {
                btn.classList.add('active');
                btn.disabled = false;
                btn.innerText = `生成切换脚本 (${selectedIds.length} 个设备)`;
            } else {
                btn.classList.remove('active');
                btn.disabled = true;
                btn.innerText = `生成切换脚本 (请至少选2个)`;
            }
        }

        // ** 5. 按钮点击事件 **
        document.getElementById('btn-gen').onclick = () => {
            document.getElementById('status-msg').innerText = '正在生成文件...';
            // 发送选中的 ID 给 C#
            window.external.sendMessage(JSON.stringify({
                action: 'generate',
                ids: selectedIds
            }));
        };

        // 首次加载时更新按钮状态
        updateButtonState();
    </script>
</body>
</html>